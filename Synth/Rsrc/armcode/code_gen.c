// register int *SB asm ("r3"); // SB
register int *MT asm ("r6"); // MT

#define SN 2048
#define SA 2047

#define DN 10
#define D (1 << DN)

struct Key {
	int A;

	int* IDR;
	int pinN;

	int state;
	int counter;
	int pressed;
};

// main with some harmonics, loop unrolled
// r0: t
// r1: K
// r2: S
// r4: M
int Gen0 (int t, const struct Key *K, const int *S) {
	const int *M;

	asm volatile ("mov %0, r4" : "=r" (M));

	return K[0].A * S[((M[0] * t) >> DN) & (SN-1)]
		 + K[1].A * S[((M[1] * t) >> DN) & (SN-1)]
		 + K[2].A * S[((M[2] * t) >> DN) & (SN-1)]
		 + K[3].A * S[((M[3] * t) >> DN) & (SN-1)]
		 + K[4].A * S[((M[4] * t) >> DN) & (SN-1)]
		 + K[5].A * S[((M[5] * t) >> DN) & (SN-1)]
		 + K[6].A * S[((M[6] * t) >> DN) & (SN-1)]
		 + K[7].A * S[((M[7] * t) >> DN) & (SN-1)]
		 + K[8].A * S[((M[8] * t) >> DN) & (SN-1)]
		 + K[9].A * S[((M[9] * t) >> DN) & (SN-1)]
		 + K[10].A * S[((M[10] * t) >> DN) & (SN-1)]
		 + K[11].A * S[((M[11] * t) >> DN) & (SN-1)]
		 + (K[12].A + (K[0].A >> 1)) * S[((M[12] * t) >> DN) & (SN-1)]
		 + (K[13].A + (K[1].A >> 1)) * S[((M[13] * t) >> DN) & (SN-1)]
		 + (K[14].A + (K[2].A >> 1)) * S[((M[14] * t) >> DN) & (SN-1)]
		 + (K[15].A + (K[3].A >> 1)) * S[((M[15] * t) >> DN) & (SN-1)]
		 + (K[16].A + (K[4].A >> 1)) * S[((M[16] * t) >> DN) & (SN-1)]
		 + (K[17].A + (K[5].A >> 1)) * S[((M[17] * t) >> DN) & (SN-1)]
		 + (K[18].A + (K[6].A >> 1)) * S[((M[18] * t) >> DN) & (SN-1)]
		 + (K[19].A + (K[7].A >> 1)) * S[((M[19] * t) >> DN) & (SN-1)]
		 + (K[20].A + (K[8].A >> 1)) * S[((M[20] * t) >> DN) & (SN-1)]
		 + (K[21].A + (K[9].A >> 1)) * S[((M[21] * t) >> DN) & (SN-1)]
		 + (K[22].A + (K[10].A >> 1)) * S[((M[22] * t) >> DN) & (SN-1)]
		 + (K[23].A + (K[11].A >> 1)) * S[((M[23] * t) >> DN) & (SN-1)]
		 + (K[24].A + (K[12].A >> 1) + (K[0].A >> 3)) * S[((M[24] * t) >> DN) & (SN-1)]
		 + (K[25].A + (K[13].A >> 1) + (K[1].A >> 3)) * S[((M[25] * t) >> DN) & (SN-1)]
		 + (K[26].A + (K[14].A >> 1) + (K[2].A >> 3)) * S[((M[26] * t) >> DN) & (SN-1)]
		 + (K[27].A + (K[15].A >> 1) + (K[3].A >> 3)) * S[((M[27] * t) >> DN) & (SN-1)]
		 + (K[28].A + (K[16].A >> 1) + (K[4].A >> 3)) * S[((M[28] * t) >> DN) & (SN-1)]
		 + (K[29].A + (K[17].A >> 1) + (K[5].A >> 3)) * S[((M[29] * t) >> DN) & (SN-1)]
		 + (K[30].A + (K[18].A >> 1) + (K[6].A >> 3)) * S[((M[30] * t) >> DN) & (SN-1)]
		 + (K[31].A + (K[19].A >> 1) + (K[7].A >> 3)) * S[((M[31] * t) >> DN) & (SN-1)]
		 + (K[32].A + (K[20].A >> 1) + (K[8].A >> 3)) * S[((M[32] * t) >> DN) & (SN-1)]
		 + (K[33].A + (K[21].A >> 1) + (K[9].A >> 3)) * S[((M[33] * t) >> DN) & (SN-1)]
		 + (K[34].A + (K[22].A >> 1) + (K[10].A >> 3)) * S[((M[34] * t) >> DN) & (SN-1)]
		 + (K[35].A + (K[23].A >> 1) + (K[11].A >> 3)) * S[((M[35] * t) >> DN) & (SN-1)]
		 + (K[36].A + (K[24].A >> 1) + (K[12].A >> 3)) * S[((M[36] * t) >> DN) & (SN-1)]
		 + (K[37].A + (K[25].A >> 1) + (K[13].A >> 3)) * S[((M[37] * t) >> DN) & (SN-1)]
		 + (K[38].A + (K[26].A >> 1) + (K[14].A >> 3)) * S[((M[38] * t) >> DN) & (SN-1)]
		 + (K[39].A + (K[27].A >> 1) + (K[15].A >> 3)) * S[((M[39] * t) >> DN) & (SN-1)]
		 + (K[40].A + (K[28].A >> 1) + (K[16].A >> 3)) * S[((M[40] * t) >> DN) & (SN-1)]
		 + (K[41].A + (K[29].A >> 1) + (K[17].A >> 3)) * S[((M[41] * t) >> DN) & (SN-1)]
		 + (K[42].A + (K[30].A >> 1) + (K[18].A >> 3)) * S[((M[42] * t) >> DN) & (SN-1)]
		 + (K[43].A + (K[31].A >> 1) + (K[19].A >> 3)) * S[((M[43] * t) >> DN) & (SN-1)]
		 + (K[44].A + (K[32].A >> 1) + (K[20].A >> 3)) * S[((M[44] * t) >> DN) & (SN-1)]
		 + (K[45].A + (K[33].A >> 1) + (K[21].A >> 3)) * S[((M[45] * t) >> DN) & (SN-1)]
		 + (K[46].A + (K[34].A >> 1) + (K[22].A >> 3)) * S[((M[46] * t) >> DN) & (SN-1)]
		 + (K[47].A + (K[35].A >> 1) + (K[23].A >> 3)) * S[((M[47] * t) >> DN) & (SN-1)]
		 + (K[48].A + (K[36].A >> 1) + (K[24].A >> 3)) * S[((M[48] * t) >> DN) & (SN-1)]
		 + (K[49].A + (K[37].A >> 1) + (K[25].A >> 3)) * S[((M[49] * t) >> DN) & (SN-1)]
		 + (K[50].A + (K[38].A >> 1) + (K[26].A >> 3)) * S[((M[50] * t) >> DN) & (SN-1)]
		 + (K[51].A + (K[39].A >> 1) + (K[27].A >> 3)) * S[((M[51] * t) >> DN) & (SN-1)]
		 + (K[52].A + (K[40].A >> 1) + (K[28].A >> 3)) * S[((M[52] * t) >> DN) & (SN-1)]
		 + (K[53].A + (K[41].A >> 1) + (K[29].A >> 3)) * S[((M[53] * t) >> DN) & (SN-1)]
		 + (K[54].A + (K[42].A >> 1) + (K[30].A >> 3)) * S[((M[54] * t) >> DN) & (SN-1)]
		 + (K[55].A + (K[43].A >> 1) + (K[31].A >> 3)) * S[((M[55] * t) >> DN) & (SN-1)]
		 + (K[56].A + (K[44].A >> 1) + (K[32].A >> 3)) * S[((M[56] * t) >> DN) & (SN-1)]
		 + (K[57].A + (K[45].A >> 1) + (K[33].A >> 3)) * S[((M[57] * t) >> DN) & (SN-1)]
		 + (K[58].A + (K[46].A >> 1) + (K[34].A >> 3)) * S[((M[58] * t) >> DN) & (SN-1)]
		 + (K[59].A + (K[47].A >> 1) + (K[35].A >> 3)) * S[((M[59] * t) >> DN) & (SN-1)]
		 + ((K[48].A >> 1) + (K[36].A >> 3)) * S[((M[60] * t) >> DN) & (SN-1)]
		 + ((K[49].A >> 1) + (K[37].A >> 3)) * S[((M[61] * t) >> DN) & (SN-1)]
		 + ((K[50].A >> 1) + (K[38].A >> 3)) * S[((M[62] * t) >> DN) & (SN-1)]
		 + ((K[51].A >> 1) + (K[39].A >> 3)) * S[((M[63] * t) >> DN) & (SN-1)]
		 + ((K[52].A >> 1) + (K[40].A >> 3)) * S[((M[64] * t) >> DN) & (SN-1)]
		 + ((K[53].A >> 1) + (K[41].A >> 3)) * S[((M[65] * t) >> DN) & (SN-1)]
		 + ((K[54].A >> 1) + (K[42].A >> 3)) * S[((M[66] * t) >> DN) & (SN-1)]
		 + ((K[55].A >> 1) + (K[43].A >> 3)) * S[((M[67] * t) >> DN) & (SN-1)]
		 + ((K[56].A >> 1) + (K[44].A >> 3)) * S[((M[68] * t) >> DN) & (SN-1)]
		 + ((K[57].A >> 1) + (K[45].A >> 3)) * S[((M[69] * t) >> DN) & (SN-1)]
		 + ((K[58].A >> 1) + (K[46].A >> 3)) * S[((M[70] * t) >> DN) & (SN-1)]
		 + ((K[59].A >> 1) + (K[47].A >> 3)) * S[((M[71] * t) >> DN) & (SN-1)]
		 + (K[48].A >> 3) * S[((M[72] * t) >> DN) & (SN-1)]
		 + (K[49].A >> 3) * S[((M[73] * t) >> DN) & (SN-1)]
		 + (K[50].A >> 3) * S[((M[74] * t) >> DN) & (SN-1)]
		 + (K[51].A >> 3) * S[((M[75] * t) >> DN) & (SN-1)]
		 + (K[52].A >> 3) * S[((M[76] * t) >> DN) & (SN-1)]
		 + (K[53].A >> 3) * S[((M[77] * t) >> DN) & (SN-1)]
		 + (K[54].A >> 3) * S[((M[78] * t) >> DN) & (SN-1)]
		 + (K[55].A >> 3) * S[((M[79] * t) >> DN) & (SN-1)]
		 + (K[56].A >> 3) * S[((M[80] * t) >> DN) & (SN-1)]
		 + (K[57].A >> 3) * S[((M[81] * t) >> DN) & (SN-1)]
		 + (K[58].A >> 3) * S[((M[82] * t) >> DN) & (SN-1)]
		 + (K[59].A >> 3) * S[((M[83] * t) >> DN) & (SN-1)];
}

// main only harmonics
// r0: t
// r1: n
// r2: K
// r4: S
// r5: M
int Gen1 (int t, int n, const struct Key *K) {
	const int *S;
	const int *M;

	asm volatile ("mov %0, r4" : "=r" (S));
	asm volatile ("mov %0, r5" : "=r" (M));

	int y = 0;

	for (int i = 0; i < n; ++i) {
		y += K[i].A * S[((M[i] * t) >> DN) & (SN-1)];
	}

	return y;
}

// main + 5 harmonics
// r0: t
// r1: n
// r2: K
// r4: S
// r5: M
int Gen (int t, int n, const struct Key *K) {
	const int *S;
	const int *M;

	asm volatile ("mov %0, r4" : "=r" (S));
	asm volatile ("mov %0, r5" : "=r" (M));

	int y = 0;

	for (int i = 0; i < n; ++i) {
		int Mt  = M[i] * t;
		int Mt3 = Mt * 3;
		y +=   K[i].A       * S[( Mt      >>  DN   ) & (SN-1)]
			+ (K[i].A >> 1) * S[( Mt      >> (DN-1)) & (SN-1)]
			+ (K[i].A >> 2) * S[( Mt3     >>  DN   ) & (SN-1)]
			+ (K[i].A >> 3) * S[( Mt      >> (DN-2)) & (SN-1)]
			+ (K[i].A >> 4) * S[((Mt * 5) >>  DN   ) & (SN-1)]
			+ (K[i].A >> 5) * S[( Mt3     >> (DN-1)) & (SN-1)];
	}

	return y;
}
